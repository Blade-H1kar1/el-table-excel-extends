<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>el-table-excel-extends 示例</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <style>
      body {
        margin: 0;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 20px;
        min-height: calc(100vh - 40px);
      }
      .header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e8e8e8;
      }

      .header h1 {
        color: #333;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <div class="header">
          <h1>el-table-excel-extends 示例</h1>
        </div>

        <!-- 功能配置面板 -->
        <el-card header="功能配置" style="margin-bottom: 20px">
          <el-row :gutter="20">
            <el-col :span="6">
              <h4>基础功能</h4>
              <el-checkbox v-model="config.copy">复制 (Ctrl+C)</el-checkbox
              ><br />
              <el-checkbox v-model="config.paste">粘贴 (Ctrl+V)</el-checkbox
              ><br />
              <el-checkbox v-model="config.cut">剪切 (Ctrl+X)</el-checkbox
              ><br />
              <el-checkbox v-model="config.fill">智能填充</el-checkbox><br />
            </el-col>
            <el-col :span="6">
              <h4>撤销重做</h4>
              <el-checkbox v-model="config.undo">撤销 (Ctrl+Z)</el-checkbox
              ><br />
              <el-checkbox v-model="config.redo">重做 (Ctrl+Y)</el-checkbox
              ><br />
            </el-col>
            <el-col :span="6">
              <h4>选择功能</h4>
              <el-checkbox v-model="config.selection">区域选择</el-checkbox
              ><br />
              <el-checkbox v-model="config.allSelection"
                >全选 (Ctrl+A)</el-checkbox
              ><br />
              <el-checkbox v-model="config.rowSelection">行选择</el-checkbox
              ><br />
              <el-checkbox v-model="config.columnSelection">列选择</el-checkbox
              ><br />
            </el-col>
            <el-col :span="6">
              <h4>其他功能</h4>
              <el-checkbox v-model="config.autoScroll">自动滚动</el-checkbox
              ><br />
              <div style="margin-top: 10px">
                <el-checkbox v-model="enableCustomMethods"
                  >启用自定义方法</el-checkbox
                ><br />
                <el-checkbox v-model="enableTextMapping"
                  >启用文本映射</el-checkbox
                >
              </div>
            </el-col>
          </el-row>
        </el-card>

        <el-table-excel-extends
          :key="componentKey"
          :copy="config.copy"
          :paste="config.paste"
          :cut="config.cut"
          :fill="config.fill"
          :undo="config.undo"
          :redo="config.redo"
          :selection="config.selection"
          :all-selection="config.allSelection"
          :row-selection="config.rowSelection"
          :column-selection="config.columnSelection"
          :auto-scroll="config.autoScroll"
          :scroll-speed="config.scrollSpeed"
          :max-undo-steps="config.maxUndoSteps"
          :get-cell-text-method="enableCustomMethods ? getCellText : null"
          :get-cell-value-method="enableCustomMethods ? getCellValue : null"
          :set-cell-value-method="enableCustomMethods ? setCellValue : null"
          :get-clear-value-method="enableCustomMethods ? getClearValue : null"
          :text-mapping-config="enableTextMapping ? textMappingConfig : null"
          :custom-mapping="enableTextMapping ? customTextMapping : null"
          @excel-copy="onExcelCopy"
          @excel-paste="onExcelPaste"
          @excel-cut="onExcelCut"
          @excel-fill="onExcelFill"
          @excel-undo="onExcelUndo"
          @excel-redo="onExcelRedo"
          @excel-select="onExcelSelect"
          @area-clear="onAreaClear"
        >
          <el-table
            ref="table"
            :data="tableData"
            height="500"
            border
            style="width: 100%"
            row-key="id"
            :tree-props="{children: 'children', hasChildren: 'hasChildren'}"
            :default-expand-all="false"
          >
            <!-- 固定左侧列 -->
            <el-table-column
              type="index"
              width="60"
              label="#"
              align="center"
              fixed="left"
            ></el-table-column>
            <el-table-column prop="name" label="姓名" width="120" fixed="left">
            </el-table-column>
            <el-table-column
              prop="department"
              label="部门"
              width="150"
              fixed="left"
            >
              <template slot-scope="scope">
                <el-select
                  v-model="scope.row.department"
                  size="mini"
                  style="width: 100%"
                >
                  <el-option label="技术部" value="1"></el-option>
                  <el-option label="产品部" value="2"></el-option>
                  <el-option label="市场部" value="3"></el-option>
                  <el-option label="人事部" value="4"></el-option>
                  <el-option label="财务部" value="5"></el-option>
                  <el-option label="运营部" value="6"></el-option>
                </el-select>
              </template>
            </el-table-column>

            <!-- 中间可滚动列 -->
            <el-table-column prop="position" label="职位" width="120">
              <template slot-scope="scope">
                <el-input v-model="scope.row.position" size="mini"></el-input>
              </template>
            </el-table-column>
            <el-table-column prop="age" label="年龄" width="120">
              <template slot-scope="scope">
                <el-input v-model="scope.row.age" size="mini"></el-input>
              </template>
            </el-table-column>
            <el-table-column prop="gender" label="性别" width="80">
              <template slot-scope="scope">
                <el-select v-model="scope.row.gender" size="mini">
                  <el-option label="男" value="1"></el-option>
                  <el-option label="女" value="2"></el-option>
                </el-select>
              </template>
            </el-table-column>
            <el-table-column prop="education" label="学历" width="100">
              <template slot-scope="scope">
                <el-select v-model="scope.row.education" size="mini">
                  <el-option label="高中" value="1"></el-option>
                  <el-option label="大专" value="2"></el-option>
                  <el-option label="本科" value="3"></el-option>
                  <el-option label="硕士" value="4"></el-option>
                  <el-option label="博士" value="5"></el-option>
                </el-select>
              </template>
            </el-table-column>
            <el-table-column prop="experience" label="工作经验" width="100"
              ><template slot-scope="scope">
                <el-input v-model="scope.row.experience" size="mini"></el-input>
              </template>
            </el-table-column>
            <el-table-column prop="phone" label="电话" width="140">
              <template slot-scope="scope">
                <el-input v-model="scope.row.phone" size="mini"></el-input>
              </template>
            </el-table-column>
            <el-table-column prop="email" label="邮箱" width="200">
              <template slot-scope="scope">
                <el-input v-model="scope.row.email" size="mini"></el-input>
              </template>
            </el-table-column>
            <el-table-column prop="address" label="地址" width="250">
              <template slot-scope="scope">
                <el-input v-model="scope.row.address" size="mini"></el-input>
              </template>
            </el-table-column>
            <el-table-column prop="joinDate" label="入职日期" width="120">
              <template slot-scope="scope">
                <el-date-picker
                  v-model="scope.row.joinDate"
                  type="date"
                  size="mini"
                  value-format="yyyy-MM-dd"
                  style="width: 100%"
                ></el-date-picker>
              </template>
            </el-table-column>
            <el-table-column prop="status" label="状态" width="100">
              <template slot-scope="scope">
                <span> {{ scope.row.status? '启用': '禁用' }} </span>
              </template>
            </el-table-column>
            <el-table-column prop="skill" label="技能" width="150">
            </el-table-column>
            <el-table-column prop="level" label="级别" width="100">
            </el-table-column>
            <el-table-column prop="project" label="项目" width="120">
            </el-table-column>
            <el-table-column prop="manager" label="直属上级" width="120">
            </el-table-column>
            <el-table-column prop="workLocation" label="工作地点" width="120">
            </el-table-column>
            <el-table-column prop="workType" label="工作类型" width="100">
            </el-table-column>
            <el-table-column prop="performance" label="绩效评分" width="120">
            </el-table-column>
            <el-table-column prop="birthday" label="生日" width="120">
            </el-table-column>
            <el-table-column
              prop="emergencyContact"
              label="紧急联系人"
              width="120"
            >
            </el-table-column>
            <el-table-column
              prop="emergencyPhone"
              label="紧急联系电话"
              width="140"
            >
            </el-table-column>
            <el-table-column prop="bankAccount" label="银行账号" width="180">
            </el-table-column>
            <el-table-column prop="socialSecurity" label="社保号" width="150">
            </el-table-column>
            <el-table-column prop="notes" label="备注" width="200">
            </el-table-column>

            <!-- 固定右侧列 -->
            <el-table-column
              prop="salary"
              label="薪资"
              width="120"
              fixed="right"
            >
            </el-table-column>
            <el-table-column
              prop="bonus"
              label="奖金"
              width="120"
              fixed="right"
            >
            </el-table-column>
          </el-table>
        </el-table-excel-extends>

        <!-- 操作区域 -->
        <div style="margin-top: 20px">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-card header="外部数据粘贴测试">
                <div style="margin-bottom: 10px">
                  <span style="font-size: 12px; color: #666">
                    复制下方文本内容，然后在表格中选择单元格区域进行粘贴测试
                  </span>
                </div>
                <el-input
                  type="textarea"
                  v-model="externalData"
                  :rows="8"
                  placeholder="这里是模拟外部复制的数据，可以复制后粘贴到表格中测试..."
                  style="font-family: monospace; font-size: 12px"
                ></el-input>
              </el-card>
            </el-col>
            <el-col :span="12">
              <el-card header="操作日志">
                <div
                  style="
                    height: 200px;
                    overflow-y: auto;
                    font-family: monospace;
                    font-size: 12px;
                    background: #f5f5f5;
                    padding: 10px;
                    border-radius: 4px;
                  "
                >
                  <div
                    v-if="operationLog.length === 0"
                    style="color: #999; text-align: center; padding: 20px"
                  >
                    暂无操作记录
                  </div>
                  <div
                    v-for="(log, index) in operationLog"
                    :key="index"
                    style="margin-bottom: 4px; color: #333"
                  >
                    {{ log }}
                  </div>
                </div>
                <div style="margin-top: 10px; text-align: right">
                  <el-button size="mini" @click="operationLog = []"
                    >清空日志</el-button
                  >
                </div>
              </el-card>
            </el-col>
          </el-row>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

    <script type="module">
      import ElTableExcelExtends from "../dist/index.js";
      window.addEventListener("load", function () {
        new Vue({
          el: "#app",
          components: {
            "el-table-excel-extends": ElTableExcelExtends,
          },
          data() {
            return {
              tableData: this.generateTableData(),
              externalData: "", // 外部数据文本
              // 功能配置
              config: {
                copy: true,
                paste: true,
                cut: true,
                fill: true,
                undo: true,
                redo: true,
                selection: true,
                allSelection: true,
                rowSelection: true,
                columnSelection: true,
                autoScroll: true,
                scrollSpeed: 10,
                maxUndoSteps: 50,
              },
              // 自定义方法开关
              enableCustomMethods: true,
              enableTextMapping: true,
              // 文本映射配置
              textMappingConfig: {
                status: {
                  启用: true,
                  禁用: false,
                  是: true,
                  否: false,
                  激活: true,
                  停用: false,
                },
                department: {
                  技术部: "1",
                  产品部: "2",
                  市场部: "3",
                  人事部: "4",
                  财务部: "5",
                  运营部: "6",
                },
                gender: {
                  男性: "1",
                  女性: "2",
                  M: "1",
                  F: "2",
                  Male: "1",
                  Female: "2",
                  男: "1",
                  女: "2",
                },
                education: {
                  高中毕业: "1",
                  大学专科: "2",
                  大学本科: "3",
                  研究生: "4",
                  博士: "5",
                  高中: "1",
                  大专: "2",
                  本科: "3",
                  硕士: "4",
                  博士: "5",
                },
              },
              // 操作日志
              operationLog: [],
            };
          },
          computed: {
            // 组件重新渲染的key，当配置改变时会触发组件重新渲染
            componentKey() {
              return JSON.stringify({
                config: this.config,
                enableCustomMethods: this.enableCustomMethods,
                enableTextMapping: this.enableTextMapping,
              });
            },
          },
          methods: {
            generateTableData() {
              const data = [];
              let id = 1;

              const techManager = {
                id: id++,
                name: "张伟",
                department: "1", // 技术部
                position: "技术总监",
                age: 35,
                gender: "1", // 男
                education: "4", // 硕士
                experience: 10,
                phone: "13812340001",
                email: "zhangwei@demo.com",
                address: "北京市海淀区",
                joinDate: "2020-01-01",
                status: true,
                salary: 30000,
                bonus: 5000,
                skill: "管理",
                level: "专家",
                project: "平台架构",
                manager: "CTO",
                workLocation: "北京",
                workType: "全职",
                performance: 5,
                birthday: "1988-01-01",
                emergencyContact: "李芳",
                emergencyPhone: "13912340001",
                bankAccount: "6222****0001",
                socialSecurity: "1101****0001",
                notes: "技术负责人",
                children: [
                  {
                    id: id++,
                    name: "李明",
                    department: "1", // 技术部
                    position: "牛马码农",
                    age: 28,
                    gender: "1", // 男
                    education: "3", // 本科
                    experience: 5,
                    phone: "13812340002",
                    email: "liming@demo.com",
                    address: "北京市朝阳区",
                    joinDate: "2021-03-01",
                    status: true,
                    salary: 18000,
                    bonus: 2000,
                    skill: "Vue.js",
                    level: "高级",
                    project: "前端开发",
                    manager: "张伟",
                    workLocation: "北京",
                    workType: "全职",
                    performance: 4,
                    birthday: "1995-05-15",
                    emergencyContact: "王静",
                    emergencyPhone: "13912340002",
                    bankAccount: "6222****0002",
                    socialSecurity: "1101****0002",
                    notes: "前端专家",
                  },
                  {
                    id: id++,
                    name: "王静",
                    department: "1", // 技术部
                    position: "后端工程师",
                    age: 30,
                    gender: "2", // 女
                    education: "4", // 硕士
                    experience: 7,
                    phone: "13812340003",
                    email: "wangjing@demo.com",
                    address: "北京市海淀区",
                    joinDate: "2020-08-01",
                    status: true,
                    salary: 22000,
                    bonus: 3000,
                    skill: "Java",
                    level: "高级",
                    project: "后端开发",
                    manager: "张伟",
                    workLocation: "北京",
                    workType: "全职",
                    performance: 5,
                    birthday: "1993-08-20",
                    emergencyContact: "李伟",
                    emergencyPhone: "13912340003",
                    bankAccount: "6222****0003",
                    socialSecurity: "1101****0003",
                    notes: "后端架构师",
                  },
                ],
              };
              data.push(techManager);

              const departments = ["2", "3", "4", "5"]; // 产品部、市场部、人事部、财务部
              const names = [
                "赵敏",
                "钱伟",
                "孙丽",
                "周强",
                "吴娜",
                "郑磊",
                "冯静",
                "陈杰",
              ];
              const positions = ["经理", "专员", "主管", "助理"];
              const skills = ["产品设计", "市场推广", "人力资源", "财务分析"];
              const levels = ["初级", "中级", "高级"];
              const projects = ["项目A", "项目B", "项目C"];

              departments.forEach((dept, deptIndex) => {
                const count = 10 + Math.floor(Math.random() * 3);
                for (let i = 0; i < count; i++) {
                  const employee = {
                    id: id++,
                    name: names[(deptIndex * 5 + i) % names.length],
                    department: dept,
                    position: positions[i % positions.length],
                    age: 25 + Math.floor(Math.random() * 15),
                    gender: i % 2 === 0 ? "1" : "2", // 1=男, 2=女
                    education: ["3", "4"][Math.floor(Math.random() * 2)], // 3=本科, 4=硕士
                    experience: Math.floor(Math.random() * 10),
                    phone: `1381234${String(1000 + id).slice(-4)}`,
                    email: `user${id}@demo.com`,
                    address: `${
                      ["北京", "上海", "广州"][Math.floor(Math.random() * 3)]
                    }市`,
                    joinDate: `202${Math.floor(Math.random() * 4)}-0${
                      Math.floor(Math.random() * 9) + 1
                    }-01`,
                    status: Math.random() > 0.2,
                    salary: 8000 + Math.floor(Math.random() * 15000),
                    bonus: Math.floor(Math.random() * 3000),
                    skill: skills[deptIndex % skills.length],
                    level: levels[Math.floor(Math.random() * 3)],
                    project: projects[Math.floor(Math.random() * 3)],
                    manager: `${
                      ["产品部", "市场部", "人事部", "财务部"][deptIndex]
                    }经理`,
                    workLocation: ["北京", "上海", "远程"][
                      Math.floor(Math.random() * 3)
                    ],
                    workType: "全职",
                    performance: 3 + Math.floor(Math.random() * 3),
                    birthday: `199${Math.floor(Math.random() * 10)}-0${
                      Math.floor(Math.random() * 9) + 1
                    }-01`,
                    emergencyContact: "家属",
                    emergencyPhone: `1391234${String(2000 + id).slice(-4)}`,
                    bankAccount: `6222****${String(3000 + id).slice(-4)}`,
                    socialSecurity: `1101****${String(4000 + id).slice(-4)}`,
                    notes: i === 0 ? "部门骨干" : "",
                  };
                  data.push(employee);
                }
              });

              return data;
            },

            generateExternalData() {
              const sampleData = [
                [
                  "张三",
                  "技术部",
                  "前端牛马",
                  "28",
                  "男性",
                  "大学本科",
                  "5",
                  "13812345001",
                  "zhangsan@demo.com",
                ],
                [
                  "李四",
                  "产品部",
                  "产品经理",
                  "30",
                  "Female",
                  "研究生",
                  "7",
                  "13812345002",
                  "lisi@demo.com",
                ],
                [
                  "王五",
                  "市场部",
                  "市场专员",
                  "26",
                  "M",
                  "高中毕业",
                  "3",
                  "13812345003",
                  "wangwu@demo.com",
                ],
                [
                  "赵六",
                  "4", // 人事部
                  "人事专员",
                  "29",
                  "F",
                  "大学专科",
                  "6",
                  "13812345004",
                  "zhaoliu@demo.com",
                ],
                [
                  "钱七",
                  "5", // 财务部
                  "会计",
                  "32",
                  "女性",
                  "博士",
                  "8",
                  "13812345005",
                  "qianqi@demo.com",
                ],
              ];

              // 转换为制表符分隔的文本格式（模拟Excel复制的数据）
              this.externalData = sampleData
                .map((row) => row.join("\t"))
                .join("\n");
            },

            // 自定义方法实现
            getCellText({ row, column, value }) {
              // 自定义获取单元格文本的方法（用于复制）
              if (column.property === "status") {
                return value ? "启用" : "禁用";
              }
              if (column.property === "joinDate" && value) {
                return new Date(value).toLocaleDateString("zh-CN");
              }
              if (column.property === "salary" && typeof value === "number") {
                return `¥${value.toLocaleString()}`;
              }
              // 手机号码和紧急联系电话脱敏处理
              if (
                (column.property === "phone" ||
                  column.property === "emergencyPhone") &&
                value
              ) {
                return value.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
              }
              return value;
            },

            getCellValue({ row, column, value }) {
              return value;
            },

            setCellValue({ row, column, value, type }, setByProp) {
              // 自定义设置单元格值的方法
              this.logOperation(`设置单元格值: ${column.label} = ${value}`);

              // 权限控制 - 只允许编辑包含自定义表单组件的列
              const editableColumns = [
                "department",
                "position",
                "age",
                "gender",
                "education",
                "experience",
                "phone",
                "email",
                "address",
                "joinDate",
              ];

              if (!editableColumns.includes(column.property)) {
                this.$message.warning(`${column.label}列不允许编辑`);
                return;
              }

              // 数据验证
              if (column.property === "age") {
                const age = Number(value);
                if (isNaN(age) || age < 18 || age > 65) {
                  this.$message.warning("年龄必须在18-65之间");
                  setByProp(row, column.property, null);
                  return;
                }
                value = age;
              }

              if (column.property === "phone") {
                // 电话号码格式验证
                const phoneRegex = /^1[3-9]\d{9}$/;
                if (value && !phoneRegex.test(value.replace(/\D/g, ""))) {
                  this.$message.warning("请输入正确的手机号码");
                  setByProp(row, column.property, null);
                  return;
                }
              }

              if (column.property === "email") {
                // 邮箱格式验证
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (value && !emailRegex.test(value)) {
                  this.$message.warning("请输入正确的邮箱地址");
                  setByProp(row, column.property, null);
                  return;
                }
              }

              if (column.property === "salary") {
                const salary = Number(value);
                if (isNaN(salary) || salary < 0) {
                  this.$message.warning("薪资必须为正数");
                  setByProp(row, column.property, null);
                  return;
                }
                value = salary;
              }

              // 设置值
              setByProp(row, column.property, value);
            },

            getClearValue({ row, column }) {
              // 自定义清空单元格值的方法
              const clearValues = {
                status: false,
                age: 18,
                salary: 0,
                bonus: 0,
                experience: 0,
                performance: 3,
                gender: "男",
                education: "本科",
                workType: "全职",
              };

              return clearValues[column.property];
            },

            customTextMapping({ value, column }) {
              // 自定义文本映射函数
              if (column.property === "joinDate") {
                // 处理各种日期格式
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                  return date.toISOString().split("T")[0];
                }
              }

              if (column.property === "salary" || column.property === "bonus") {
                // 处理带货币符号的数字
                const num = parseFloat(
                  value.toString().replace(/[^\d.-]/g, "")
                );
                return isNaN(num) ? 0 : num;
              }

              if (column.property === "phone") {
                // 清理电话号码格式
                return value.toString().replace(/\D/g, "");
              }

              return value;
            },

            // 事件处理方法
            onExcelCopy({ copiedCells, copiedData, bounds }) {
              this.logOperation(`复制了 ${copiedCells.length} 个单元格`);
              console.log("复制数据:", copiedData);
            },

            onExcelPaste({ affectedCells, pastedData, bounds }) {
              this.logOperation(`粘贴了 ${affectedCells.length} 个单元格`);
              this.$message.success(
                `成功粘贴 ${affectedCells.length} 个单元格`
              );
            },

            onExcelCut({ cutCells, cutData }) {
              this.logOperation(`剪切了 ${cutCells.length} 个单元格`);
            },

            onExcelFill({ filledCells, fillData, bounds }) {
              this.logOperation(`填充了 ${filledCells.length} 个单元格`);
              this.$message.success(
                `智能填充完成，影响 ${filledCells.length} 个单元格`
              );
            },

            onExcelUndo({ affectedCells }) {
              this.logOperation(
                `撤销操作，影响 ${affectedCells.length} 个单元格`
              );
            },

            onExcelRedo({ affectedCells }) {
              this.logOperation(
                `重做操作，影响 ${affectedCells.length} 个单元格`
              );
            },

            onExcelSelect({ selectedCells, bounds }) {
              if (selectedCells.length > 1) {
                console.log(`选择了 ${selectedCells.length} 个单元格`);
              }
            },

            onAreaClear({ clearedCells }) {
              this.logOperation(`清空了 ${clearedCells.length} 个单元格`);
            },

            logOperation(message) {
              const timestamp = new Date().toLocaleTimeString();
              this.operationLog.unshift(`[${timestamp}] ${message}`);
              // 保持日志数量在合理范围内
              if (this.operationLog.length > 50) {
                this.operationLog = this.operationLog.slice(0, 50);
              }
            },

            pinyin(text) {
              const pinyinMap = {
                张: "zhang",
                李: "li",
                王: "wang",
                赵: "zhao",
                钱: "qian",
                孙: "sun",
                周: "zhou",
                吴: "wu",
                郑: "zheng",
                冯: "feng",
                陈: "chen",
                伟: "wei",
                明: "ming",
                静: "jing",
                敏: "min",
                丽: "li",
                强: "qiang",
                磊: "lei",
                娜: "na",
                杰: "jie",
              };
              return text
                .split("")
                .map((char) => pinyinMap[char] || char)
                .join("");
            },
          },

          mounted() {
            this.generateExternalData();
          },
        });
      });
    </script>
  </body>
</html>
